<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <template id="report_deliveryslip_inherit_airflow" inherit_id="stock.report_deliveryslip">
        <!-- Set flag to use in report footer -->
        <xpath expr="//t[@t-foreach='docs']" position="before">
            <t t-set="is_deliveryslip" t-value="True"/>
        </xpath>
    </template>

    <template id="report_delivery_document_inherit_airflow" inherit_id="stock.report_delivery_document">
        <!-- Report-specific styles -->
        <xpath expr="//t[@t-set='o']" position="before">
            <style>
                .origin {
                font-size: initial;
                vertical-align: middle;
                padding-bottom: 4px;
                }
                .line_below {
                width: 100%;
                border-bottom: 1px solid;
                }
                h4 {
                padding: 1px;
                margin: 0px;
                }
            </style>
        </xpath>
        <!-- Add row for Shipping Method and Sales Rep and Project Name -->
        <xpath expr="//t[@t-set='address']" position="before">
            <div class="row mt16 mb16">
                <div class="col-xs-8">
                    <h4>
                        <span>Project Name:</span>
                        <span t-field="o.proj_name"/>
                    </h4>
                    <h4>
                        <span>Ship Attn To:</span>
                        <span t-field="o.ship_attn"/>
                    </h4>
                    <h4>
                        <span>Customer PO:</span>
                        <span t-field="o.cust_po"/>
                    </h4>
                </div>

                <div class="col-xs-4 pull-right">
                    <div>
                        <span>Sales Rep:</span>
                        <span t-field="o.sales_rep"/>
                    </div>
                    <div>
                        <span>Email:</span>
                        <span t-esc="o.sales_rep.email" t-options='{"widget": "email"}'/>
                    </div>
                    <div>
                        <span>Phone:</span>
                        <span t-esc="o.sales_rep.phone" t-options='{"widget": "phone"}'/>
                    </div>

                </div>
            </div>
        </xpath>
        <!-- Replace address row with Ship To address and Customer Address -->
        <xpath expr="//t[@t-set='address']" position="replace">
            <t t-set="partner" t-value="o.partner_id or (o.move_lines and o.move_lines[0].partner_id) or False"/>
            <t t-set="parent" t-value="(partner and partner.parent_id) or partner or False"/>
            <div class="row" name="customer_address">
                <div class="col-xs-4">
                    <div>
                        <span>
                            <strong>Ship To Address:</strong>
                        </span>
                    </div>
                    <div t-if="partner" name="ship_to_address">
                        <span t-esc="partner.parent_id.name if partner.parent_id else partner.name"/>
                        <div t-esc="partner"
                             t-options='{"widget": "contact", "fields": ["address", "phone"], "no_marker": True}'/>
                    </div>
                </div>
                <div class="col-xs-4 pull-right">
                    <div>
                        <span>
                            <strong>Customer Address:</strong>
                        </span>
                    </div>
                    <div t-if="parent" name="customer_address">
                        <span t-esc="partner.parent_id.name if partner.parent_id else partner.name"/>
                        <div t-esc="parent"
                             t-options='{"widget": "contact", "fields": ["address", "phone"], "no_marker": True}'/>
                    </div>
                </div>
            </div>
        </xpath>
        <!-- Add origin after name -->
        <xpath expr="//div[hasclass('page')]//span[@t-field='o.name']" position="after">
            <span class="origin" t-if="o.origin" t-field="o.origin"/>
        </xpath>
        <!-- Remove time from date -->
        <xpath expr="//p[@t-field='o.date_done']" position="attributes">
            <attribute name="t-options">{"widget": "date"}</attribute>
        </xpath>
        <xpath expr="//p[@t-field='o.scheduled_date']" position="attributes">
            <attribute name="t-options">{"widget": "date"}</attribute>
        </xpath>
        <!-- Add Cust Job #, Cust PO # and Shipping method (the custom field) to table -->
        <xpath expr="//th[@name='th_sm_quantity']" position="after">
            <th t-if="o.job_code">
                <strong>Cust Job #</strong>
            </th>
            <th t-if="o.cust_po">
                <strong>Cust PO #</strong>
            </th>
            <th t-if="o.ship_method">
                <strong>Shipping Method</strong>
            </th>
        </xpath>
        <xpath expr="//td[last()]" position="after">
            <td t-if="o.job_code">
                <span t-esc="o.job_code"/>
            </td>
            <td t-if="o.cust_po">
                <span t-esc="o.cust_po"/>
            </td>
            <td t-if="o.ship_method">
                <span t-field="o.ship_method"/>
            </td>
        </xpath>
        <!-- Overhaul the move lines tables -->
        <xpath expr="//tr[@t-as='move']/ancestor::table" position="replace">
            <t t-set="lines" t-value="o.move_lines.filtered(lambda x: x.product_uom_qty)"/>
            <t t-set="has_tag" t-value="any([move.tag for move in lines])"/>
            <t t-set="has_po_tag" t-value="any([move.po_tag for move in lines])"/>
            <t t-set="has_model" t-value="any([move.product_model for move in lines])"/>
            <t t-set="has_manufacturer" t-value="any([move.manufacturer for move in lines])"/>
            <table class="table table-condensed mt48" t-if="o.state!='done'">
                <thead>
                    <tr>
                        <th>
                            <strong>Qty</strong>
                        </th>
                        <th t-if="has_model">
                            <strong>Model</strong>
                        </th>
                        <th>
                            <strong>Item #</strong>
                        </th>
                        <th>
                            <strong>Product Description</strong>
                        </th>
                        <!-- <th t-if="has_manufacturer"> -->
                        <!--     <strong>Manufacturer</strong> -->
                        <!-- </th> -->
                        <th t-if="has_tag">
                            <strong>Tag</strong>
                        </th>
                        <!-- <th t-if="has_po_tag"> -->
                        <!--     <strong>PO Tag</strong> -->
                        <!-- </th> -->
                    </tr>
                </thead>
                <tbody>
                    <tr t-foreach="lines.sorted(lambda l: l.id)" t-as="move">
                        <td>
                            <span t-field="move.product_uom_qty"/>
                            <span t-field="move.product_uom"/>
                        </td>
                        <td t-if="has_model">
                            <span t-field="move.product_model"/>
                        </td>
                        <td>
                            <span t-field="move.product_id"/>
                            <p t-if="o.picking_type_code == 'outgoing'">
                                <span t-field="move.product_id.sudo().description_pickingout"/>
                            </p>
                            <p t-if="o.picking_type_code == 'incoming'">
                                <span t-field="move.product_id.sudo().description_pickingin"/>
                            </p>
                        </td>
                        <td>
                            <span t-field="move.product_description"/>
                        </td>
                        <!-- <td t-if="has_manufacturer"> -->
                        <!--     <span t-field="move.manufacturer"/> -->
                        <!-- </td> -->
                        <td t-if="has_tag">
                            <span t-field="move.tag"/>
                        </td>
                        <!-- <td t-if="has_po_tag"> -->
                        <!--     <span t-field="move.po_tag"/> -->
                        <!-- </td> -->
                    </tr>
                </tbody>
            </table>
        </xpath>
        <!-- Overhaul move lines table when state == done -->
        <xpath expr="//tr[@t-foreach='o.move_line_ids']/ancestor::table" position="replace">
            <table class="table table-condensed mt48" t-if="o.move_line_ids and o.state=='done'">
                <t t-set="has_tag" t-value="any([move_line.move_id.tag for move_line in o.move_line_ids])"/>
                <t t-set="has_model" t-value="any([move_line.product_id.model for move_line in o.move_line_ids])"/>
                <t t-set="has_serial_number" t-value="o.move_line_ids.mapped('lot_id')"
                   groups="stock.group_production_lot"/>
                <t t-set="has_manufacturer"
                   t-value="any([move_line.product_id.seller_ids.name for move_line in o.move_line_ids])"/>
                <thead>
                    <tr>
                        <th>
                            <strong>Qty</strong>
                        </th>
                        <th t-if="has_model">
                            <strong>Model</strong>
                        </th>
                        <th>
                            <strong>Item #</strong>
                        </th>
                        <th name="lot_serial" t-if="has_serial_number">
                            Lot/Serial Number
                        </th>
                        <th>
                            <strong>Product Description</strong>
                        </th>
                        <!-- <th t-if="has_manufacturer"> -->
                        <!--     <strong>Manufacturer</strong> -->
                        <!-- </th> -->
                        <th t-if="has_tag">
                            <strong>Tag</strong>
                        </th>
                        <!-- <th t-if="has_po_tag"> -->
                        <!--     <strong>PO Tag</strong> -->
                        <!-- </th> -->
                    </tr>
                </thead>
                <tbody>
                    <tr t-foreach="o.move_line_ids.sorted(key=lambda line: line.id)" t-as="move_line">
                        <!-- Quantity -->
                        <td class="text-center">
                            <span t-field="move_line.qty_done"/>
                            <span t-field="move_line.product_uom_id"/>
                        </td>
                        <!-- Model -->
                        <td t-if="has_model">
                            <span t-field="move_line.product_id.model"/>
                        </td>
                        <!-- Item # -->
                        <td>
                            <span t-field="move_line.product_id"/>
                            <p t-if="o.picking_type_code == 'outgoing'">
                                <span t-field="move_line.product_id.sudo().description_pickingout"/>
                            </p>
                            <p t-if="o.picking_type_code == 'incoming'">
                                <span t-field="move_line.product_id.sudo().description_pickingin"/>
                            </p>
                        </td>
                        <!-- Lot/Serial Number -->
                        <td t-if="has_serial_number">
                            <table width="100%">
                                <tr>
                                    <td>
                                        <span t-field="move_line.lot_id"/>
                                        <t t-if="not move_line.lot_id">
                                            <span t-field="move_line.lot_name"/>
                                        </t>
                                    </td>
                                    <td name="lot_qty">
                                        <t t-if="move_line.product_qty">
                                            <span t-field="move_line.product_qty"/>
                                        </t>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <!-- Product Description -->
                        <td>
                            <span t-field="move_line.product_id.sudo().description_sale"/>
                        </td>
                        <!-- Manufacturer -->
                        <!-- <td t-if="has_manufacturer"> -->
                        <!--     <span t-field="move_line.product_id.seller_ids.name"/> -->
                        <!-- </td> -->
                        <!-- Tag -->
                        <td t-if="has_tag">
                            <span t-field="move_line.move_id.tag"/>
                        </td>
                        <!-- <td t-if="has_po_tag"> -->
                        <!--     <span t-field="move_line.move_id.po_tag"/> -->
                        <!-- </td> -->
                    </tr>
                </tbody>
            </table>
        </xpath>
        <!-- Add Sign, Date and Print spaces -->
        <xpath expr="//div[hasclass('page')]" position="inside">
            <div class="row mt32" name="signature">
                <div class="col-4 text-center">
                    <div class="line_below">&#160;</div>
                    <span>Sign</span>
                </div>
                <div class="col-4 text-center">
                    <div class="line_below">&#160;</div>
                    <span>Print</span>
                </div>
                <div class="col-4 text-center">
                    <div class="line_below">&#160;</div>
                    <span>Date</span>
                </div>
            </div>
        </xpath>
    </template>
</odoo>
